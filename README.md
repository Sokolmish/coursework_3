# Diploma

This is an optimizing compiler for the subset of the C99 language producing LLVM assembler.

This project is my bachelor's diploma work.

There are [one](/tests/tst_prog1.c) of test programs and [another one](/tests/tst_prog1.c).

## Requirements

- **CMake**
- **gcc-10** and above
- **LLVM-13** and above (because early versions cannot be compiled with C++20)
- **[fmtlib](https://fmt.dev/latest/index.html)** (tested with versions 6 and 8)

Following packages are used for code generation.
They are optional because all code, that should be generated by them, is already included in this repository.

- [**Flex**](https://github.com/westes/flex) and [**Bison**](https://www.gnu.org/software/bison)
- [**Gperf**](https://www.gnu.org/software/gperf)

## Building

To build this compiler one should execute following commands, which are common for most CMake projects. Executable binary (`cw39`) will be placed in the `build` directory.

```sh
mkdir build
cd build
cmake ..
make
```

By default, all code generators are enabled.
But if you don't have such generators installed, the project can be built using already generated source files.
To do this, one should call CMake with some of following options:

- `-DCW39_NO_BISON=TRUE` to disable flex and bison
- `-DCW39_NO_GPERF=TRUE` to disable gperf

For example, cmake command can be executed as shown below.

```
cmake -DCW39_NO_BISON=TRUE -DCW39_NO_GPERF=TRUE ..
```

Also, if you have troubles with CMake and generators communication, you can generate source codes manually using this [Makefile](/src/parser/Makefile).

### Building using Docker

Docker container can be built using the [`setup.sh`](/setup.sh) script. After the first usage, this command should be executed if [Dockerfile](/Dockerfile) was changed.

Project can be built using the [`build.sh`](/build.sh) script. This script will store final binary and building files in the `docker_build` directory created by previous script.

Both scripts don't expect arguments and should be executed from project root (where Dockerfile is located). Optionally, one can specify number of threads used by make in the build script (default is 3).

## Usage

```
cw39 [options] <input_file>
```

### Options

Each of following options can accept optional argument with path (e.g. `--llvm=./out.ll`). In this case output will be written into specified file. Otherwise, it will be written into stdout. Without any of these options, compiler will print nothing but errors.

- `--preproc` - print preprocessor output
- `--ast` - print abstract syntax tree with pseudo graphics
- `--ir` - print final IR
- `--cfg` - print final CFG representation in the [dot](https://graphviz.org/) language
- `--ir-raw` - print IR before optimizations (i.e. right after generation)
- `--cfg-raw` - print CFG representation before optimizations in the [dot](https://graphviz.org/) language
- `--llvm` - print final LLVM assembler code
- `--asm` - print assmbly code (only in Unix-based systems)

### External programs customization

This compiler uses some external programs via fork-exec calls.
This behaviour available only on Unix-based systems and disabled for other ones.

One can specify names for used executables via environment variables listed below.

- `CW39_LLC` - name of llc from LLVM toolchain (default: `llc`)

For example:

```sh
export CW39_LLC=llc-13
cw39 --asm ./test.c
# Or
CW39_LLC=llc-13 cw39 --asm ./test.c
```

## Examples

Print LLVM code into terminal:
```sh
cw39 --llvm ./test.c
```

Print LLVM code into the `out.ll` file:
```sh
cw39 --llvm=out.ll ./test.c
```

Execute generated code immediately (also `lli-13` and others can be used):
```sh
cw39 --llvm ./test.c | lli
```

Draw CFG into the `graph.svg` file:
```sh
cw39 --cfg ./test.c | dot -Tsvg -o graph.svg
```
